{% extends 'base.html.twig' %}

{% block title %}D√©tails R√©clamation #{{ reclamation.id }} - Backoffice{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-12">
            <a href="{{ path('admin_reclamation_index') }}" class="btn btn-secondary mb-3">‚Üê Retour</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">{{ reclamation.titre }}</h5>
                        <small class="text-muted">R√©clamation #{{ reclamation.id }}</small>
                    </div>
                    {% if reclamation.statut == 'En attente' %}
                        <span class="badge bg-label-warning">En attente</span>
                    {% elseif reclamation.statut == 'En cours' %}
                        <span class="badge bg-label-info">En cours</span>
                    {% else %}
                        <span class="badge bg-label-success">R√©solu</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Date de cr√©ation:</strong>
                        <p>{{ reclamation.dateCreation|date('d/m/Y √† H:i') }}</p>
                    </div>

                    <div class="mb-3">
                        <strong>Description:</strong>
                        <p class="text-justify">{{ reclamation.description }}</p>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <strong>Statut actuel:</strong>
                        <p>{{ reclamation.statut }}</p>
                    </div>
                </div>
                <div class="card-footer bg-transparent d-flex gap-2">
                    <a href="{{ path('admin_reclamation_edit', {'id': reclamation.id}) }}" 
                       class="btn btn-warning">Modifier Statut</a>
                    <!-- Dropdown personnalis√© sans Bootstrap -->
                    <div style="position: relative; display: inline-block;">
                        <button id="translateBtn" style="
                            background-color: #0dcaf0;
                            color: white;
                            padding: 6px 16px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: background-color 0.2s;
                        " onmouseover="this.style.backgroundColor='#0bb5d9'" onmouseout="this.style.backgroundColor='#0dcaf0'">
                            üåê Traduire
                        </button>
                        
                        <div id="translateDropdown" style="
                            display: none;
                            position: absolute;
                            background-color: white;
                            min-width: 220px;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            padding: 12px 0;
                            z-index: 1000;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            top: 100%;
                            left: 0;
                            margin-top: 5px;
                        ">
                            <a href="#" data-lang="en" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">English (Anglais)</a>
                            
                            <a href="#" data-lang="es" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">Espa√±ol (Espagnol)</a>
                            
                            <a href="#" data-lang="de" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">Deutsch (Allemand)</a>
                            
                            <a href="#" data-lang="it" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">Italiano (Italien)</a>
                            
                            <a href="#" data-lang="pt" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">Portugu√™s (Portugais)</a>
                            
                            <a href="#" data-lang="ja" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">Êó•Êú¨Ë™û (Japonais)</a>
                            
                            <a href="#" data-lang="zh" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">‰∏≠Êñá (Chinois)</a>
                            
                            <a href="#" data-lang="ar" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabe)</a>
                            
                            <a href="#" data-lang="ru" class="translate-option" style="
                                color: black;
                                padding: 10px 16px;
                                text-decoration: none;
                                display: block;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">–†—É—Å—Å–∫–∏–π (Russe)</a>
                        </div>
                    </div>
                    <form method="POST" action="{{ path('admin_reclamation_delete', {'id': reclamation.id}) }}" 
                          style="display:inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reclamation.id) }}">
                        <button type="submit" class="btn btn-danger" 
                                onclick="return confirm('√ätes-vous s√ªr?')">
                            Supprimer
                        </button>
                    </form>
                </div>
            </div>

            <!-- Section des traductions (cach√© par d√©faut) -->
            <div id="translationSection" style="display: none;" class="card mb-4 mt-3">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">üåê Traduction
                        <span id="translatedLangName" class="badge bg-primary"></span>
                    </h5>
                    <button type="button" class="btn-close" id="closeTranslation"></button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Titre traduit:</strong>
                        <p id="translatedTitre" class="bg-light p-2 rounded">-</p>
                    </div>
                    <div class="mb-3">
                        <strong>Description traduite:</strong>
                        <p id="translatedDescription" class="bg-light p-2 rounded" style="max-height: 300px; overflow-y: auto;">-</p>
                    </div>
                </div>
            </div>

            <!-- Stockage des donn√©es pour JavaScript -->
            <div id="translationData" 
                 data-titre="{{ reclamation.titre|escape('html') }}"
                 data-description="{{ reclamation.description|escape('html') }}"
                 style="display: none;"></div>

            {% if reclamation.reponses %}
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">R√©ponses Envoy√©es ({{ reclamation.reponses|length }})</h5>
                    <a href="{{ path('admin_reponse_new', {'reclamationId': reclamation.id}) }}" 
                       class="btn btn-success btn-sm">+ Ajouter R√©ponse</a>
                </div>
                <div class="card-body">
                    {% for reponse in reclamation.reponses %}
                    <div class="mb-3 p-3 border-start border-info rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>R√©ponse Support</strong>
                                <small class="d-block text-muted">{{ reponse.dateReponse|date('d/m/Y √† H:i') }}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-info dropdown-toggle translateReponseAdminBtn" data-bs-toggle="dropdown" data-reponse-id="{{ reponse.id }}" aria-expanded="false">
                                        <i class="fas fa-globe"></i>
                                    </button>
                                    <ul class="dropdown-menu translateReponseAdminDropdown" data-reponse-id="{{ reponse.id }}">
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="en">English</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="es">Espa√±ol</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="de">Deutsch</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="it">Italiano</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="pt">Portugu√™s</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="ja">Êó•Êú¨Ë™û</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="zh">‰∏≠Êñá</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a></li>
                                        <li><a class="dropdown-item translate-reponse-admin-item" href="#" data-lang="ru">–†—É—Å—Å–∫–∏–π</a></li>
                                    </ul>
                                </div>
                                <a href="{{ path('admin_reponse_edit', {'id': reponse.id}) }}" class="btn btn-sm btn-warning">√âditer</a>
                                <form method="POST" action="{{ path('admin_reponse_delete', {'id': reponse.id}) }}" style="display:inline;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reponse.id) }}">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('√ätes-vous s√ªr?')">Supprimer</button>
                                </form>
                            </div>
                        </div>
                        <p class="mt-2 mb-0" id="reponse-admin-{{ reponse.id }}">{{ reponse.contenu }}</p>
                        <div id="translation-admin-{{ reponse.id }}" style="display: none; margin-top: 10px; padding: 10px; background-color: #e7f3ff; border-radius: 4px; border-left: 4px solid #0053e3;"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <strong>Aucune r√©ponse envoy√©e</strong> - 
                <a href="{{ path('admin_reponse_new', {'reclamationId': reclamation.id}) }}" class="alert-link">Ajouter une r√©ponse</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Script loaded'); // Debug
    
    // ===== GESTION DU DROPDOWN PERSONNALIS√â =====
    const dropdownButton = document.getElementById('translateBtn');
    const dropdownMenu = document.getElementById('translateDropdown');
    const translateOptions = document.querySelectorAll('.translate-option');
    
    // Ouvrir/Fermer le dropdown au clic du bouton
    if (dropdownButton) {
        dropdownButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üí¨ Dropdown button clicked');
            dropdownMenu.style.display = dropdownMenu.style.display === 'none' ? 'block' : 'none';
        });
    }
    
    // G√©rer le clic sur les options de langue
    translateOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const lang = this.getAttribute('data-lang');
            console.log('üåê Language selected:', lang);
            
            if (lang) {
                translateReclamation(lang);
                // Fermer le dropdown
                dropdownMenu.style.display = 'none';
            }
        });
    });
    
    // Fermer le dropdown quand on clique ailleurs
    document.addEventListener('click', function(e) {
        if (e.target !== dropdownButton && e.target.parentElement !== dropdownMenu) {
            dropdownMenu.style.display = 'none';
        }
    });
    
    // ===== √âL√âMENT DU DOM =====
    const translationSection = document.getElementById('translationSection');
    const closeTranslationBtn = document.getElementById('closeTranslation');
    const translatedLangName = document.getElementById('translatedLangName');
    const translatedTitre = document.getElementById('translatedTitre');
    const translatedDescription = document.getElementById('translatedDescription');
    const translationData = document.getElementById('translationData');

    // Langues disponibles
    const langNames = {
        'en': 'English',
        'es': 'Espa√±ol',
        'de': 'Deutsch',
        'it': 'Italiano',
        'pt': 'Portugu√™s',
        'ja': 'Êó•Êú¨Ë™û',
        'zh': '‰∏≠Êñá',
        'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
        'ru': '–†—É—Å—Å–∫–∏–π'
    };

    // R√©cup√©rer les donn√©es depuis les attributs data
    function getTitreAndDescription() {
        const titre = translationData ? translationData.getAttribute('data-titre') : '';
        const description = translationData ? translationData.getAttribute('data-description') : '';
        return { titre, description };
    }
    
    // Traductions des r√©ponses (admin)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('translate-reponse-admin-item')) {
            e.preventDefault();
            const lang = e.target.getAttribute('data-lang');
            const dropdown = e.target.closest('.translateReponseAdminDropdown');
            if (dropdown && lang) {
                const reponseId = dropdown.getAttribute('data-reponse-id');
                if (reponseId) {
                    console.log('Translating response:', reponseId, lang);
                    translateReponseAdmin(reponseId, lang);
                }
            }
        }
    });

    // Fermer la section de traduction
    if (closeTranslationBtn) {
        closeTranslationBtn.addEventListener('click', function(e) {
            e.preventDefault();
            translationSection.style.display = 'none';
        });
    }

    function translateReclamation(targetLang) {
        console.log('üîÑ Starting translation to:', targetLang);
        const { titre, description } = getTitreAndDescription();

        if (!titre || !description) {
            console.error('‚ùå Titre ou description vides');
            alert('Erreur: Titre ou description manquants');
            return;
        }

        // Afficher un indicateur de chargement
        translatedLangName.textContent = langNames[targetLang] || targetLang;
        translatedTitre.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traduction en cours...';
        translatedDescription.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traduction en cours...';
        translationSection.style.display = 'block';

        console.log('üìÑ Data to translate:', { titre: titre.substring(0, 50) + '...', description: description.substring(0, 50) + '...', targetLang });

        // Faire deux requ√™tes API pour traduire titre et description
        Promise.all([
            fetch(`/api/translate/text?text=${encodeURIComponent(titre)}&targetLang=${targetLang}`)
                .then(r => {
                    console.log('Titre API response status:', r.status);
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .catch(err => {
                    console.error('Titre translation error:', err);
                    return { success: false, error: err.message };
                }),
            fetch(`/api/translate/text?text=${encodeURIComponent(description)}&targetLang=${targetLang}`)
                .then(r => {
                    console.log('Description API response status:', r.status);
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .catch(err => {
                    console.error('Description translation error:', err);
                    return { success: false, error: err.message };
                })
        ])
        .then(([resTitre, resDescription]) => {
            console.log('‚úÖ API Response:', { resTitre, resDescription });
            if (resTitre.success && resDescription.success) {
                translatedTitre.textContent = resTitre.translated;
                translatedDescription.textContent = resDescription.translated;
                console.log('‚úÖ Translation completed');
            } else {
                const errorMsg = resTitre.error || resDescription.error || 'Erreur lors de la traduction';
                translatedTitre.textContent = '‚ùå Erreur: ' + errorMsg;
                translatedDescription.textContent = '‚ùå Erreur: ' + errorMsg;
                console.error('‚ùå Translation failed:', errorMsg);
            }
        })
        .catch(error => {
            console.error('‚ùå Fetch Error:', error);
            translatedTitre.textContent = '‚ùå Erreur de connexion: ' + error.message;
            translatedDescription.textContent = '‚ùå Erreur de connexion: ' + error.message;
        });
    }

    // ===== Traduction des r√©ponses (Admin) =====
    function translateReponseAdmin(reponseId, targetLang) {
        const reponseElement = document.getElementById(`reponse-admin-${reponseId}`);
        const translationDiv = document.getElementById(`translation-admin-${reponseId}`);

        if (!reponseElement || !translationDiv) {
            console.error(`√âl√©ments non trouv√©s pour reponse ${reponseId}`);
            return;
        }

        const reponseContent = reponseElement.textContent.trim();

        if (!reponseContent) {
            console.error(`Contenu vide pour reponse ${reponseId}`);
            return;
        }

        // Afficher un indicateur de chargement
        translationDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traduction en cours...';
        translationDiv.style.display = 'block';

        // Requ√™te API pour traduire la r√©ponse
        fetch(`/api/translate/text?text=${encodeURIComponent(reponseContent)}&targetLang=${targetLang}`)
            .then(r => {
                if (!r.ok) throw new Error(`Erreur HTTP: ${r.status}`);
                return r.json();
            })
            .then(res => {
                if (res.success) {
                    translationDiv.innerHTML = `<strong>üìù Traduction (${langNames[targetLang] || targetLang}):</strong><br><p style="margin-top: 8px; margin-bottom: 0;">${res.translated}</p>`;
                    translationDiv.style.display = 'block';
                } else {
                    translationDiv.innerHTML = `<strong>Erreur:</strong> ${res.error || 'Erreur lors de la traduction'}`;
                    translationDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                translationDiv.innerHTML = `<strong>Erreur de connexion:</strong> ${error.message}`;
                translationDiv.style.display = 'block';
            });
    }
});
</script>
{% endblock %}
