{% extends "frontend/base.html.twig" %}

{% block title %}Mes Commandes - Pharmax{% endblock %}

{% block content %}
<div class="mb-5">
    <h1 class="mb-2">Mes Commandes</h1>
    <p class="text-muted">Consultez l'historique et les détails de vos commandes</p>
</div>

<div class="card">
    <div class="card-header">
        <div class="row g-3">
            <div class="col-md-8">
                <input type="text" id="search-q" class="form-control" placeholder="Rechercher par e-mail, total ou date...">
            </div>
            <div class="col-md-4">
                <select id="search-statut" class="form-select">
                    <option value="">Tous les statuts</option>
                    <option value="en_attente">En attente</option>
                    <option value="payee">Payée</option>
                    <option value="annule">Annulée</option>
                </select>
            </div>
        </div>
    </div>
    <div class="card-body" id="commandes-list">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Utilisateur</th>
                    <th>Total</th>
                    <th>Statut</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for commande in commandes %}
                    <tr>
                        <td>{{ commande.utilisateur.email }}</td>
                        <td>{{ commande.totales|number_format(2, ',', ' ') }} DT</td>
                        <td><span class="badge bg-label-{{ commande.statut == 'payee' ? 'success' : (commande.statut == 'annule' ? 'danger' : 'warning') }}">{{ commande.statut }}</span></td>
                        <td>{{ commande.createdAt|date('d/m/Y H:i') }}</td>
                        <td>
                            <a href="{{ path('app_commande_show', {'id': commande.id}) }}" class="btn btn-sm btn-primary">Voir</a>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center">Aucune commande trouvée.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="d-flex justify-content-center mt-3">
            {% if commandes is defined %}
                {{ knp_pagination_render(commandes) }}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('search-q');
            const searchStatutInput = document.getElementById('search-statut');
            const commandesList = document.getElementById('commandes-list');

            function fetchCommandes() {
                const q = searchInput.value;
                const statut = searchStatutInput.value;
                const url = new URL('{{ url('app_commande_index') }}');
                url.searchParams.set('ajax', '1');
                url.searchParams.set('page', '1');

                if (q) {
                    url.searchParams.set('q', q);
                }
                if (statut) {
                    url.searchParams.set('statut', statut);
                }

                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    commandesList.innerHTML = html;
                });
            }

            searchInput.addEventListener('keyup', fetchCommandes);
            searchStatutInput.addEventListener('change', fetchCommandes);

            // Intercepter les clics sur la pagination (AJAX)
            commandesList.addEventListener('click', function (e) {
                const link = e.target.closest('.pagination a');
                if (!link) return;
                e.preventDefault();
                const url = new URL(link.href);
                url.searchParams.set('ajax', '1');
                // Conserver les filtres actuels
                const q = searchInput.value;
                const statut = searchStatutInput.value;
                if (q) url.searchParams.set('q', q);
                if (statut) url.searchParams.set('statut', statut);
                fetch(url, {
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                })
                .then(r => r.text())
                .then(html => { commandesList.innerHTML = html; });
            });
        });
    </script>
{% endblock %}
