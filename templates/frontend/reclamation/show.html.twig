{% extends 'misho-base.html.twig' %}

{% block title %}D√©tails - {{ reclamation.titre }}{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ path('frontend_reclamation_index') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Retour √† mes r√©clamations
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="misho-card">
            <div class="misho-card-header">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h5 style="margin: 0 0 5px 0;">{{ reclamation.titre }}</h5>
                        <small style="color: #999;">R√©clamation #{{ reclamation.id }}</small>
                    </div>
                    <div>
                        {% if reclamation.statut == 'En attente' %}
                            <span class="misho-badge badge-waiting">‚è≥ En attente</span>
                        {% elseif reclamation.statut == 'En cours' %}
                            <span class="misho-badge badge-progress">‚öôÔ∏è En cours</span>
                        {% else %}
                            <span class="misho-badge badge-resolved">‚úÖ R√©solu</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="misho-card-body">
                <div class="mb-3">
                    <strong>Date de cr√©ation:</strong>
                    <p>{{ reclamation.dateCreation|date('d/m/Y √† H:i') }}</p>
                </div>

                <div class="mb-3">
                    <strong>Description:</strong>
                    <p style="line-height: 1.6;">{{ reclamation.description }}</p>
                </div>
            </div>

            <div class="misho-card-footer">
                <a href="{{ path('frontend_reclamation_edit', {'id': reclamation.id}) }}" 
                   class="btn btn-sm btn-primary" aria-label="Modifier la r√©clamation">
                    <i class="fas fa-edit" aria-hidden="true"></i>
                    <span class="ms-1">Modifier</span>
                </a>
                <form method="POST" action="{{ path('frontend_reclamation_delete', {'id': reclamation.id}) }}" 
                      style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reclamation.id) }}">
                    <button type="submit" class="btn btn-sm btn-primary" aria-label="Supprimer la r√©clamation"
                            onclick="return confirm('√ätes-vous s√ªr?')">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                        <span class="ms-1">Supprimer</span>
                    </button>
                </form>
            </div>
        </div>

        {% if reclamation.reponses %}
        <div class="misho-card mt-4">
            <div class="misho-card-header">
                <h5 style="margin: 0;">üí¨ R√©ponses de l'√©quipe support ({{ reclamation.reponses|length }})</h5>
            </div>
            <div class="misho-card-body">
                {% for reponse in reclamation.reponses %}
                <div style="margin-bottom: 20px; padding: 15px; border-left: 4px solid #ff0000; background-color: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong>Support Pharmax</strong>
                            <small style="display: block; color: #999;">{{ reponse.dateReponse|date('d/m/Y √† H:i') }}</small>
                        </div>
                        <div class="btn-group" role="group" style="margin-left: 10px;">
                            <button type="button" class="btn btn-sm btn-info dropdown-toggle translateReponseBtn" data-bs-toggle="dropdown" data-reponse-id="{{ reponse.id }}" aria-expanded="false">
                                <i class="fas fa-globe"></i>
                            </button>
                            <ul class="dropdown-menu translateReponseDropdown" data-reponse-id="{{ reponse.id }}">
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="en">English</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="es">Espa√±ol</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="de">Deutsch</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="it">Italiano</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="pt">Portugu√™s</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="ja">Êó•Êú¨Ë™û</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="zh">‰∏≠Êñá</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a></li>
                                <li><a class="dropdown-item translate-reponse-item" href="#" data-lang="ru">–†—É—Å—Å–∫–∏–π</a></li>
                            </ul>
                        </div>
                    </div>
                    <p style="margin: 0; line-height: 1.6; margin-bottom: 10px;" class="reponse-content" id="reponse-{{ reponse.id }}">{{ reponse.contenu }}</p>
                    <div id="translation-{{ reponse.id }}" style="display: none; margin-top: 10px; padding: 10px; background-color: #e8f4f8; border-radius: 4px; border-left: 4px solid #007bff;"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning mt-4">
            <i class="fas fa-hourglass-end"></i>
            <strong>En attente de r√©ponse</strong> - Notre √©quipe est en train de traiter votre r√©clamation.
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const langNames = {
        'en': 'English',
        'es': 'Espa√±ol',
        'de': 'Deutsch',
        'it': 'Italiano',
        'pt': 'Portugu√™s',
        'ja': 'Êó•Êú¨Ë™û',
        'zh': '‰∏≠Êñá',
        'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
        'ru': '–†—É—Å—Å–∫–∏–π'
    };

    // ===== Traduction des r√©ponses (Frontend) =====
    // Utiliser la d√©l√©gation d'√©v√©nements pour capturer les clics
    document.addEventListener('click', function(e) {
        // V√©rifier si c'est un item de traduction de r√©ponse
        if (e.target.classList.contains('translate-reponse-item')) {
            e.preventDefault();
            const lang = e.target.getAttribute('data-lang');
            
            // Trouver le dropdown parent pour obtenir l'ID de la r√©ponse
            const dropdown = e.target.closest('.translateReponseDropdown');
            if (dropdown) {
                const reponseId = dropdown.getAttribute('data-reponse-id');
                if (reponseId) {
                    translateReponse(reponseId, lang);
                }
            }
        }
    });

    function translateReponse(reponseId, targetLang) {
        const reponseElement = document.getElementById(`reponse-${reponseId}`);
        const translationDiv = document.getElementById(`translation-${reponseId}`);

        if (!reponseElement || !translationDiv) {
            console.error(`√âl√©ments non trouv√©s pour reponse ${reponseId}`);
            return;
        }

        const reponseContent = reponseElement.textContent.trim();

        if (!reponseContent) {
            console.error(`Contenu vide pour reponse ${reponseId}`);
            return;
        }

        // Afficher un indicateur de chargement
        translationDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traduction en cours...';
        translationDiv.style.display = 'block';

        // Requ√™te API pour traduire la r√©ponse
        fetch(`/api/translate/text?text=${encodeURIComponent(reponseContent)}&targetLang=${targetLang}`)
            .then(r => {
                if (!r.ok) throw new Error(`Erreur HTTP: ${r.status}`);
                return r.json();
            })
            .then(res => {
                if (res.success) {
                    translationDiv.innerHTML = `<strong>üìù Traduction (${langNames[targetLang] || targetLang}):</strong><br><p style="margin-top: 8px; margin-bottom: 0;">${res.translated}</p>`;
                    translationDiv.style.display = 'block';
                } else {
                    translationDiv.innerHTML = `<strong>Erreur:</strong> ${res.error || 'Erreur lors de la traduction'}`;
                    translationDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                translationDiv.innerHTML = `<strong>Erreur de connexion:</strong> ${error.message}`;
                translationDiv.style.display = 'block';
            });
    }
});
</script>
{% endblock %}
